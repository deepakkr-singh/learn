# ============================================================================
# VARIABLES FOR CREATING STEP FUNCTIONS STATE MACHINES
# ============================================================================
#
# INSTRUCTIONS:
# 1. Copy this file to variables.tf
# 2. Customize default values as needed
# 3. Set values in terraform.tfvars
#
# ============================================================================

# ----------------------------------------------------------------------------
# REQUIRED VARIABLES
# ----------------------------------------------------------------------------

variable "project_name" {
  description = "Project name for resource naming"
  type        = string
  default     = "myproject"
}

variable "environment" {
  description = "Environment (dev, staging, prod)"
  type        = string
  default     = "dev"

  validation {
    condition     = contains(["dev", "staging", "prod"], var.environment)
    error_message = "Environment must be dev, staging, or prod"
  }
}

variable "state_machine_name" {
  description = "Name of the state machine"
  type        = string
}

variable "state_machine_definition" {
  description = "State machine definition (Amazon States Language JSON)"
  type        = string
}

# ----------------------------------------------------------------------------
# STATE MACHINE CONFIGURATION
# ----------------------------------------------------------------------------

variable "state_machine_type" {
  description = "State machine type (STANDARD or EXPRESS)"
  type        = string
  default     = "STANDARD"

  validation {
    condition     = contains(["STANDARD", "EXPRESS"], var.state_machine_type)
    error_message = "State machine type must be STANDARD or EXPRESS"
  }

  # STANDARD: Long-running (up to 1 year), exactly-once execution
  # EXPRESS:  Short-running (up to 5 min), at-least-once execution
}

# ----------------------------------------------------------------------------
# IAM ROLE
# ----------------------------------------------------------------------------

variable "create_iam_role" {
  description = "Create IAM role for state machine?"
  type        = bool
  default     = true
}

variable "existing_role_arn" {
  description = "ARN of existing IAM role (if not creating new one)"
  type        = string
  default     = ""
}

variable "lambda_functions" {
  description = "List of Lambda function ARNs that state machine will invoke"
  type        = list(string)
  default     = []

  # Example: ["arn:aws:lambda:us-east-1:123456789012:function:my-function"]
}

variable "sns_topics" {
  description = "List of SNS topic ARNs that state machine will publish to"
  type        = list(string)
  default     = []
}

variable "sqs_queues" {
  description = "List of SQS queue ARNs that state machine will send messages to"
  type        = list(string)
  default     = []
}

variable "dynamodb_tables" {
  description = "List of DynamoDB table ARNs that state machine will access"
  type        = list(string)
  default     = []
}

variable "ecs_task_definitions" {
  description = "List of ECS task definition ARNs that state machine will run"
  type        = list(string)
  default     = []
}

variable "custom_iam_policy" {
  description = "Custom IAM policy JSON for additional permissions"
  type        = string
  default     = ""
}

# ----------------------------------------------------------------------------
# LOGGING
# ----------------------------------------------------------------------------

variable "enable_logging" {
  description = "Enable CloudWatch logging?"
  type        = bool
  default     = true
}

variable "log_retention_days" {
  description = "CloudWatch log retention (days)"
  type        = number
  default     = 7

  # Options: 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653
}

variable "log_level" {
  description = "Log level (ALL, ERROR, FATAL, OFF)"
  type        = string
  default     = "ERROR"

  validation {
    condition     = contains(["ALL", "ERROR", "FATAL", "OFF"], var.log_level)
    error_message = "Log level must be ALL, ERROR, FATAL, or OFF"
  }
}

variable "log_include_execution_data" {
  description = "Include execution data in logs?"
  type        = bool
  default     = false

  # true  = Log input/output data (may contain sensitive info)
  # false = Don't log input/output data (recommended)
}

# ----------------------------------------------------------------------------
# TRACING
# ----------------------------------------------------------------------------

variable "enable_xray_tracing" {
  description = "Enable AWS X-Ray tracing?"
  type        = bool
  default     = false

  # true  = Enable X-Ray for distributed tracing (costs extra)
  # false = No X-Ray tracing
}

# ----------------------------------------------------------------------------
# MONITORING (CLOUDWATCH ALARMS)
# ----------------------------------------------------------------------------

variable "create_alarms" {
  description = "Create CloudWatch alarms for monitoring?"
  type        = bool
  default     = false
}

variable "alarm_sns_topic_arns" {
  description = "List of SNS topic ARNs for alarm notifications"
  type        = list(string)
  default     = []
}

# ----------------------------------------------------------------------------
# TAGS
# ----------------------------------------------------------------------------

variable "common_tags" {
  description = "Common tags to apply to all resources"
  type        = map(string)
  default = {
    ManagedBy = "Terraform"
    Module    = "step-functions"
  }
}

# ----------------------------------------------------------------------------
# EXAMPLE terraform.tfvars
# ----------------------------------------------------------------------------
/*

# Configuration 1: Simple Order Processing Workflow
# --------------------------------------------------
# Cost: ~$0.40/month (10,000 orders × 8 states = 80,000 transitions)

project_name        = "ecommerce"
environment         = "prod"
state_machine_name  = "order-processing"
state_machine_type  = "STANDARD"

# State machine definition
state_machine_definition = jsonencode({
  Comment = "Order processing workflow"
  StartAt = "ValidateOrder"
  States = {
    ValidateOrder = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:validate-order"
      Retry = [{
        ErrorEquals     = ["States.Timeout", "ServiceException"]
        IntervalSeconds = 2
        MaxAttempts     = 3
        BackoffRate     = 2.0
      }]
      Catch = [{
        ErrorEquals = ["States.ALL"]
        ResultPath  = "$.error"
        Next        = "OrderFailed"
      }]
      Next = "CheckInventory"
    }

    CheckInventory = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:check-inventory"
      Next     = "ProcessPayment"
    }

    ProcessPayment = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:process-payment"
      Retry = [{
        ErrorEquals     = ["PaymentTimeout"]
        IntervalSeconds = 2
        MaxAttempts     = 3
        BackoffRate     = 2.0
      }]
      Catch = [{
        ErrorEquals = ["PaymentDeclined"]
        ResultPath  = "$.error"
        Next        = "PaymentDeclined"
      }]
      Next = "CreateShipment"
    }

    CreateShipment = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:create-shipment"
      Next     = "SendConfirmation"
    }

    SendConfirmation = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:send-email"
      End      = true
    }

    PaymentDeclined = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:send-declined-email"
      End      = true
    }

    OrderFailed = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:send-error-email"
      End      = true
    }
  }
})

# IAM
create_iam_role = true
lambda_functions = [
  "arn:aws:lambda:us-east-1:123456789012:function:validate-order",
  "arn:aws:lambda:us-east-1:123456789012:function:check-inventory",
  "arn:aws:lambda:us-east-1:123456789012:function:process-payment",
  "arn:aws:lambda:us-east-1:123456789012:function:create-shipment",
  "arn:aws:lambda:us-east-1:123456789012:function:send-email",
  "arn:aws:lambda:us-east-1:123456789012:function:send-declined-email",
  "arn:aws:lambda:us-east-1:123456789012:function:send-error-email"
]

# Logging
enable_logging = true
log_level      = "ERROR"
log_retention_days = 7

# Monitoring
create_alarms = true
alarm_sns_topic_arns = ["arn:aws:sns:us-east-1:123456789012:alerts"]

# Tags
common_tags = {
  Project   = "Ecommerce"
  Team      = "Orders"
  ManagedBy = "Terraform"
}


# Configuration 2: Approval Workflow with Wait State
# ---------------------------------------------------
# Cost: ~$0.10/month (1,000 approvals × 5 states = 5,000 transitions)

project_name        = "myapp"
environment         = "prod"
state_machine_name  = "approval-workflow"
state_machine_type  = "STANDARD"

state_machine_definition = jsonencode({
  Comment = "Approval workflow for high-value orders"
  StartAt = "ValidateOrder"
  States = {
    ValidateOrder = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:validate-order"
      Next     = "CheckOrderValue"
    }

    CheckOrderValue = {
      Type = "Choice"
      Choices = [
        {
          Variable           = "$.total"
          NumericGreaterThan = 1000
          Next               = "RequestApproval"
        }
      ]
      Default = "ProcessOrder"
    }

    RequestApproval = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:request-approval"
      Next     = "WaitForApproval"
    }

    WaitForApproval = {
      Type    = "Wait"
      Seconds = 3600
      Next    = "CheckApprovalStatus"
    }

    CheckApprovalStatus = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:check-approval"
      Next     = "ApprovalDecision"
    }

    ApprovalDecision = {
      Type = "Choice"
      Choices = [
        {
          Variable      = "$.approved"
          BooleanEquals = true
          Next          = "ProcessOrder"
        }
      ]
      Default = "OrderRejected"
    }

    ProcessOrder = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:process-order"
      End      = true
    }

    OrderRejected = {
      Type  = "Fail"
      Error = "OrderRejected"
      Cause = "Order was not approved within 1 hour"
    }
  }
})

create_iam_role = true
lambda_functions = [
  "arn:aws:lambda:us-east-1:123456789012:function:validate-order",
  "arn:aws:lambda:us-east-1:123456789012:function:request-approval",
  "arn:aws:lambda:us-east-1:123456789012:function:check-approval",
  "arn:aws:lambda:us-east-1:123456789012:function:process-order"
]


# Configuration 3: Parallel Processing Workflow
# ----------------------------------------------
# Cost: ~$0.20/month (5,000 orders × 6 states = 30,000 transitions)

project_name        = "myapp"
environment         = "prod"
state_machine_name  = "parallel-processing"
state_machine_type  = "STANDARD"

state_machine_definition = jsonencode({
  Comment = "Process order and send notifications in parallel"
  StartAt = "ProcessPayment"
  States = {
    ProcessPayment = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:process-payment"
      Next     = "ParallelTasks"
    }

    ParallelTasks = {
      Type = "Parallel"
      Branches = [
        {
          StartAt = "CreateShipment"
          States = {
            CreateShipment = {
              Type     = "Task"
              Resource = "arn:aws:lambda:us-east-1:123456789012:function:create-shipment"
              Next     = "UpdateInventory"
            }
            UpdateInventory = {
              Type     = "Task"
              Resource = "arn:aws:lambda:us-east-1:123456789012:function:update-inventory"
              End      = true
            }
          }
        },
        {
          StartAt = "SendEmail"
          States = {
            SendEmail = {
              Type     = "Task"
              Resource = "arn:aws:lambda:us-east-1:123456789012:function:send-email"
              Next     = "SendSMS"
            }
            SendSMS = {
              Type     = "Task"
              Resource = "arn:aws:lambda:us-east-1:123456789012:function:send-sms"
              End      = true
            }
          }
        }
      ]
      Next = "OrderComplete"
    }

    OrderComplete = {
      Type = "Succeed"
    }
  }
})

create_iam_role = true
lambda_functions = [
  "arn:aws:lambda:us-east-1:123456789012:function:process-payment",
  "arn:aws:lambda:us-east-1:123456789012:function:create-shipment",
  "arn:aws:lambda:us-east-1:123456789012:function:update-inventory",
  "arn:aws:lambda:us-east-1:123456789012:function:send-email",
  "arn:aws:lambda:us-east-1:123456789012:function:send-sms"
]


# Configuration 4: Map State (Process Array Items)
# ------------------------------------------------
# Cost: ~$0.15/month (1,000 orders × 3 states × 5 items = 15,000 transitions)

project_name        = "myapp"
environment         = "prod"
state_machine_name  = "batch-processing"
state_machine_type  = "STANDARD"

state_machine_definition = jsonencode({
  Comment = "Process multiple items in an order"
  StartAt = "ValidateOrder"
  States = {
    ValidateOrder = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:validate-order"
      Next     = "ProcessItems"
    }

    ProcessItems = {
      Type           = "Map"
      ItemsPath      = "$.orderItems"
      MaxConcurrency = 10
      Iterator = {
        StartAt = "CheckStock"
        States = {
          CheckStock = {
            Type     = "Task"
            Resource = "arn:aws:lambda:us-east-1:123456789012:function:check-stock"
            Next     = "ReserveItem"
          }
          ReserveItem = {
            Type     = "Task"
            Resource = "arn:aws:lambda:us-east-1:123456789012:function:reserve-item"
            Next     = "UpdateInventory"
          }
          UpdateInventory = {
            Type     = "Task"
            Resource = "arn:aws:lambda:us-east-1:123456789012:function:update-inventory"
            End      = true
          }
        }
      }
      Next = "ProcessPayment"
    }

    ProcessPayment = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:process-payment"
      End      = true
    }
  }
})

create_iam_role = true
lambda_functions = [
  "arn:aws:lambda:us-east-1:123456789012:function:validate-order",
  "arn:aws:lambda:us-east-1:123456789012:function:check-stock",
  "arn:aws:lambda:us-east-1:123456789012:function:reserve-item",
  "arn:aws:lambda:us-east-1:123456789012:function:update-inventory",
  "arn:aws:lambda:us-east-1:123456789012:function:process-payment"
]


# Configuration 5: Express Workflow (High-Volume API)
# ----------------------------------------------------
# Cost: ~$1.00/month (1M requests, 2 seconds avg)

project_name        = "myapp"
environment         = "prod"
state_machine_name  = "api-workflow"
state_machine_type  = "EXPRESS"

state_machine_definition = jsonencode({
  Comment = "Fast API response workflow"
  StartAt = "ValidateInput"
  States = {
    ValidateInput = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:validate-input"
      Next     = "ProcessRequest"
    }

    ProcessRequest = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:process-request"
      Next     = "FormatResponse"
    }

    FormatResponse = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:format-response"
      End      = true
    }
  }
})

create_iam_role = true
lambda_functions = [
  "arn:aws:lambda:us-east-1:123456789012:function:validate-input",
  "arn:aws:lambda:us-east-1:123456789012:function:process-request",
  "arn:aws:lambda:us-east-1:123456789012:function:format-response"
]

enable_logging = true
log_level      = "ERROR"


# Configuration 6: DynamoDB Integration
# --------------------------------------

project_name        = "myapp"
environment         = "prod"
state_machine_name  = "dynamodb-workflow"
state_machine_type  = "STANDARD"

state_machine_definition = jsonencode({
  Comment = "Workflow with DynamoDB integration"
  StartAt = "SaveOrder"
  States = {
    SaveOrder = {
      Type     = "Task"
      Resource = "arn:aws:states:::dynamodb:putItem"
      Parameters = {
        TableName = "orders"
        Item = {
          orderId   = { "S.$" = "$.orderId" }
          timestamp = { "N.$" = "$.timestamp" }
          status    = { "S" = "processing" }
        }
      }
      Next = "ProcessOrder"
    }

    ProcessOrder = {
      Type     = "Task"
      Resource = "arn:aws:lambda:us-east-1:123456789012:function:process-order"
      Next     = "UpdateStatus"
    }

    UpdateStatus = {
      Type     = "Task"
      Resource = "arn:aws:states:::dynamodb:updateItem"
      Parameters = {
        TableName = "orders"
        Key = {
          orderId = { "S.$" = "$.orderId" }
        }
        UpdateExpression = "SET #status = :status"
        ExpressionAttributeNames = {
          "#status" = "status"
        }
        ExpressionAttributeValues = {
          ":status" = { "S" = "completed" }
        }
      }
      End = true
    }
  }
})

create_iam_role = true
lambda_functions = ["arn:aws:lambda:us-east-1:123456789012:function:process-order"]
dynamodb_tables  = ["arn:aws:dynamodb:us-east-1:123456789012:table/orders"]

*/

# ----------------------------------------------------------------------------
# COST ESTIMATION GUIDE
# ----------------------------------------------------------------------------
/*

Step Functions Pricing:
-----------------------

Standard Workflow:
├─ $0.025 per 1,000 state transitions
├─ First 4,000 transitions/month free
└─ No charge for duration

Express Workflow (Synchronous):
├─ $1.00 per 1 million requests
├─ $0.00001667 per GB-second
└─ Use for: API workflows

Express Workflow (Asynchronous):
├─ $0.25 per 1 million requests
├─ $0.00001667 per GB-second
└─ Use for: Event-driven workflows


Cost Examples:
--------------

Example 1: Order Processing (10,000 orders/month, 8 states)
├─ Total transitions: 10,000 × 8 = 80,000
├─ Billable: 80,000 - 4,000 (free tier) = 76,000
├─ Cost: 76,000 / 1,000 × $0.025 = $1.90/month

Example 2: Approval Workflow (1,000 approvals/month, 5 states)
├─ Total transitions: 1,000 × 5 = 5,000
├─ Billable: 5,000 - 4,000 (free tier) = 1,000
├─ Cost: 1,000 / 1,000 × $0.025 = $0.025/month

Example 3: Data Pipeline (100 jobs/month, 20 states)
├─ Total transitions: 100 × 20 = 2,000
├─ Billable: 0 (within free tier)
├─ Cost: $0/month

Example 4: Express API (1M requests/month, 2 seconds avg)
├─ Request cost: 1,000,000 / 1,000,000 × $1.00 = $1.00
├─ Duration cost: Minimal (~$0.03)
├─ Total: ~$1.03/month

Example 5: High-Volume Batch (1M executions, 10 states)
├─ Standard: 10,000,000 / 1,000 × $0.025 = $250/month
├─ Express async: 1,000,000 / 1,000,000 × $0.25 = $0.25/month
├─ Savings: 99.9%! (Use Express for high volume)


Cost-Saving Tips:
-----------------

1. Minimize State Transitions
   ❌ 10 separate states for small operations = 10 transitions
   ✓ Combine in 1 Lambda function = 1 transition
   Savings: 90%

2. Use Express for High Volume
   ❌ Standard: 1M executions × 5 states = $125/month
   ✓ Express: 1M executions = $0.25/month
   Savings: 99.8%

3. Batch with Map State
   ❌ 1,000 separate executions = 1,000 × cost
   ✓ 1 execution with Map processing 1,000 items = 1 × cost
   Savings: Up to 99.9%

4. Optimize Parallel Branches
   ❌ 5 branches × 10 states = 50 transitions
   ✓ 2 optimized branches × 5 states = 10 transitions
   Savings: 80%

*/
