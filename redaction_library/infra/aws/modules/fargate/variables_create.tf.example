# ============================================================================
# VARIABLES FOR CREATING FARGATE SERVICE
# ============================================================================
#
# INSTRUCTIONS:
# 1. Copy this file to variables.tf
# 2. Customize default values as needed
# 3. Set values in terraform.tfvars
#
# ============================================================================

# ----------------------------------------------------------------------------
# REQUIRED VARIABLES
# ----------------------------------------------------------------------------

variable "project_name" {
  description = "Project name for resource naming"
  type        = string
  default     = "myproject"
}

variable "environment" {
  description = "Environment (dev, staging, prod)"
  type        = string
  default     = "dev"

  validation {
    condition     = contains(["dev", "staging", "prod"], var.environment)
    error_message = "Environment must be dev, staging, or prod"
  }
}

variable "service_name" {
  description = "Name of the ECS service"
  type        = string
}

variable "container_image" {
  description = "Docker image to run (e.g., nginx:latest, myrepo/myapp:v1.0)"
  type        = string
}

variable "subnet_ids" {
  description = "List of subnet IDs where tasks will run"
  type        = list(string)

  # Should be PRIVATE subnets for security
}

variable "security_group_ids" {
  description = "List of security group IDs for tasks"
  type        = list(string)
}

# ----------------------------------------------------------------------------
# ECS CLUSTER CONFIGURATION
# ----------------------------------------------------------------------------

variable "create_cluster" {
  description = "Create new ECS cluster?"
  type        = bool
  default     = true
}

variable "cluster_name" {
  description = "Name of ECS cluster"
  type        = string
  default     = ""

  # If empty, auto-generated: projectname-environment-cluster
}

variable "existing_cluster_id" {
  description = "ID of existing ECS cluster (if not creating new one)"
  type        = string
  default     = ""
}

variable "existing_cluster_name" {
  description = "Name of existing ECS cluster (if not creating new one)"
  type        = string
  default     = ""
}

variable "enable_container_insights" {
  description = "Enable CloudWatch Container Insights?"
  type        = bool
  default     = false

  # Provides detailed metrics but costs extra
}

# ----------------------------------------------------------------------------
# SERVICE CONFIGURATION
# ----------------------------------------------------------------------------

variable "create_service" {
  description = "Create ECS service?"
  type        = bool
  default     = true
}

variable "desired_count" {
  description = "Number of tasks to run"
  type        = number
  default     = 1

  # Auto-scaling will adjust this based on load
}

variable "assign_public_ip" {
  description = "Assign public IP to tasks?"
  type        = bool
  default     = false

  # true  = Tasks in public subnet (not recommended)
  # false = Tasks in private subnet (recommended)
}

# ----------------------------------------------------------------------------
# TASK DEFINITION
# ----------------------------------------------------------------------------

variable "task_family_name" {
  description = "Task definition family name"
  type        = string
  default     = ""
}

variable "task_cpu" {
  description = "Task CPU units (256 = 0.25 vCPU, 512 = 0.5 vCPU, 1024 = 1 vCPU)"
  type        = string
  default     = "256"

  validation {
    condition     = contains(["256", "512", "1024", "2048", "4096"], var.task_cpu)
    error_message = "Task CPU must be 256, 512, 1024, 2048, or 4096"
  }
}

variable "task_memory" {
  description = "Task memory in MB"
  type        = string
  default     = "512"

  # Must match valid CPU/memory combinations:
  # 256 CPU  → 512, 1024, 2048
  # 512 CPU  → 1024, 2048, 3072, 4096
  # 1024 CPU → 2048-8192 (1GB increments)
  # 2048 CPU → 4096-16384 (1GB increments)
  # 4096 CPU → 8192-30720 (1GB increments)
}

variable "execution_role_arn" {
  description = "IAM role ARN for ECS task execution (pulls image, writes logs)"
  type        = string

  # Required permissions: ecr:GetAuthorizationToken, ecr:BatchCheckLayerAvailability, logs:CreateLogStream
}

variable "task_role_arn" {
  description = "IAM role ARN for task (permissions your app needs)"
  type        = string
  default     = ""

  # Example: Access to S3, DynamoDB, SQS
}

# ----------------------------------------------------------------------------
# CONTAINER CONFIGURATION
# ----------------------------------------------------------------------------

variable "container_name" {
  description = "Name of the container"
  type        = string
  default     = "app"
}

variable "container_cpu" {
  description = "Container CPU units (leave at 0 to use all task CPU)"
  type        = number
  default     = 0
}

variable "container_memory" {
  description = "Container memory in MB (leave at 0 to use all task memory)"
  type        = number
  default     = 0
}

variable "container_port" {
  description = "Port the container listens on"
  type        = number
  default     = 8080

  # Set to 0 if container doesn't expose any ports
}

variable "environment_variables" {
  description = "Environment variables for container"
  type        = map(string)
  default     = {}

  # Example: {ENV = "production", LOG_LEVEL = "info"}
}

variable "secrets" {
  description = "Secrets from Secrets Manager or Parameter Store"
  type        = map(string)
  default     = {}

  # Example: {DB_PASSWORD = "arn:aws:secretsmanager:..."}
}

# ----------------------------------------------------------------------------
# HEALTH CHECK
# ----------------------------------------------------------------------------

variable "health_check_command" {
  description = "Container health check command (comma-separated)"
  type        = string
  default     = ""

  # Example: "CMD-SHELL,curl -f http://localhost:8080/health || exit 1"
}

variable "health_check_interval" {
  description = "Health check interval (seconds)"
  type        = number
  default     = 30
}

variable "health_check_timeout" {
  description = "Health check timeout (seconds)"
  type        = number
  default     = 5
}

variable "health_check_retries" {
  description = "Health check retries"
  type        = number
  default     = 3
}

variable "health_check_start_period" {
  description = "Health check start period (seconds)"
  type        = number
  default     = 0

  # Grace period before health checks start
}

# ----------------------------------------------------------------------------
# LOAD BALANCER
# ----------------------------------------------------------------------------

variable "target_group_arn" {
  description = "ALB target group ARN"
  type        = string
  default     = ""

  # Leave empty if not using ALB
}

variable "health_check_grace_period" {
  description = "Health check grace period for ALB (seconds)"
  type        = number
  default     = 60

  # Time before ALB starts health checks
}

# ----------------------------------------------------------------------------
# SERVICE DISCOVERY
# ----------------------------------------------------------------------------

variable "service_discovery_arn" {
  description = "Service discovery registry ARN"
  type        = string
  default     = ""

  # For service-to-service communication
}

# ----------------------------------------------------------------------------
# DEPLOYMENT CONFIGURATION
# ----------------------------------------------------------------------------

variable "deployment_maximum_percent" {
  description = "Maximum percent of tasks during deployment"
  type        = number
  default     = 200

  # 200 = Can have up to 2x tasks during deployment (rolling update)
}

variable "deployment_minimum_healthy_percent" {
  description = "Minimum healthy percent during deployment"
  type        = number
  default     = 100

  # 100 = Always maintain at least desired count during deployment
}

# ----------------------------------------------------------------------------
# FARGATE SPOT
# ----------------------------------------------------------------------------

variable "use_fargate_spot" {
  description = "Use Fargate Spot (70% cheaper but can be interrupted)?"
  type        = bool
  default     = false

  # true  = Use Spot instances (save money, accept interruptions)
  # false = Use regular Fargate (more expensive, guaranteed)
}

variable "fargate_spot_weight" {
  description = "Weight for Fargate Spot capacity provider"
  type        = number
  default     = 100

  # 100 = Use Spot for all tasks (if available)
}

variable "fargate_spot_base" {
  description = "Base number of tasks to run on regular Fargate"
  type        = number
  default     = 0

  # Keep critical tasks on regular Fargate, rest on Spot
}

# ----------------------------------------------------------------------------
# AUTO-SCALING
# ----------------------------------------------------------------------------

variable "enable_autoscaling" {
  description = "Enable auto-scaling?"
  type        = bool
  default     = false
}

variable "autoscaling_min_capacity" {
  description = "Minimum number of tasks"
  type        = number
  default     = 1
}

variable "autoscaling_max_capacity" {
  description = "Maximum number of tasks"
  type        = number
  default     = 10
}

variable "autoscaling_cpu_target" {
  description = "Target CPU utilization (0-100, 0 to disable)"
  type        = number
  default     = 70

  # Scale up when CPU > 70%, scale down when CPU < 70%
}

variable "autoscaling_memory_target" {
  description = "Target memory utilization (0-100, 0 to disable)"
  type        = number
  default     = 0

  # Set to 0 to disable memory-based scaling
}

variable "autoscaling_scale_in_cooldown" {
  description = "Cooldown period after scale in (seconds)"
  type        = number
  default     = 300

  # Wait 5 minutes before scaling down again
}

variable "autoscaling_scale_out_cooldown" {
  description = "Cooldown period after scale out (seconds)"
  type        = number
  default     = 60

  # Wait 1 minute before scaling up again
}

# ----------------------------------------------------------------------------
# LOGGING
# ----------------------------------------------------------------------------

variable "log_retention_days" {
  description = "CloudWatch log retention (days)"
  type        = number
  default     = 7

  # Options: 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653
}

# ----------------------------------------------------------------------------
# ECS EXEC (DEBUGGING)
# ----------------------------------------------------------------------------

variable "enable_ecs_exec" {
  description = "Enable ECS Exec for debugging?"
  type        = bool
  default     = false

  # Allows you to run commands in running containers
}

# ----------------------------------------------------------------------------
# TAGS
# ----------------------------------------------------------------------------

variable "common_tags" {
  description = "Common tags to apply to all resources"
  type        = map(string)
  default = {
    ManagedBy = "Terraform"
    Module    = "fargate"
  }
}

# ----------------------------------------------------------------------------
# EXAMPLE terraform.tfvars
# ----------------------------------------------------------------------------
/*

# Configuration 1: Simple API Service
# ------------------------------------
# Cost: ~$18/month (0.5 vCPU, 1GB, 24/7)

project_name = "myapp"
environment  = "prod"
service_name = "api-service"

# Container
container_image = "123456789012.dkr.ecr.us-east-1.amazonaws.com/myapp:latest"
container_name  = "api"
container_port  = 8080

# Resources
task_cpu    = "512"   # 0.5 vCPU
task_memory = "1024"  # 1 GB

# Networking
subnet_ids         = ["subnet-private-1a", "subnet-private-1b"]
security_group_ids = ["sg-ecs-tasks"]
assign_public_ip   = false

# Service
desired_count = 2  # Run 2 tasks for high availability

# Load Balancer
target_group_arn = "arn:aws:elasticloadbalancing:..."

# IAM
execution_role_arn = "arn:aws:iam::123456789012:role/ecsTaskExecutionRole"
task_role_arn      = "arn:aws:iam::123456789012:role/myapp-task-role"

# Environment
environment_variables = {
  ENV       = "production"
  LOG_LEVEL = "info"
}

# Secrets
secrets = {
  DB_PASSWORD = "arn:aws:secretsmanager:us-east-1:123456789012:secret:db-password"
  API_KEY     = "arn:aws:secretsmanager:us-east-1:123456789012:secret:api-key"
}

# Logging
log_retention_days = 7

common_tags = {
  Project   = "MyApp"
  Team      = "Backend"
  ManagedBy = "Terraform"
}


# Configuration 2: Auto-Scaling Service
# --------------------------------------
# Cost: $18-180/month (scales 2-20 tasks based on load)

project_name = "ecommerce"
environment  = "prod"
service_name = "order-processor"

container_image = "123456789012.dkr.ecr.us-east-1.amazonaws.com/order-processor:v2.0"
container_port  = 8080

# Resources
task_cpu    = "512"
task_memory = "1024"

# Networking
subnet_ids         = ["subnet-private-1a", "subnet-private-1b"]
security_group_ids = ["sg-order-processor"]
assign_public_ip   = false

# Service
desired_count = 2  # Starting point (auto-scaling will adjust)

# Auto-Scaling
enable_autoscaling        = true
autoscaling_min_capacity  = 2
autoscaling_max_capacity  = 20
autoscaling_cpu_target    = 70  # Scale when CPU > 70%
autoscaling_memory_target = 0   # Don't scale based on memory

# Load Balancer
target_group_arn         = "arn:aws:elasticloadbalancing:..."
health_check_grace_period = 60

# IAM
execution_role_arn = "arn:aws:iam::123456789012:role/ecsTaskExecutionRole"
task_role_arn      = "arn:aws:iam::123456789012:role/order-processor-role"

# Environment
environment_variables = {
  ENV              = "production"
  MAX_CONNECTIONS  = "100"
  QUEUE_URL        = "https://sqs.us-east-1.amazonaws.com/123456789012/orders"
}


# Configuration 3: Fargate Spot (70% Savings)
# --------------------------------------------
# Cost: ~$5-10/month (Spot pricing, can be interrupted)

project_name = "analytics"
environment  = "dev"
service_name = "batch-processor"

container_image = "analytics/batch-processor:latest"
container_port  = 0  # No exposed ports

# Resources
task_cpu    = "256"   # 0.25 vCPU
task_memory = "512"   # 512 MB

# Networking
subnet_ids         = ["subnet-private-1a"]
security_group_ids = ["sg-batch"]
assign_public_ip   = false

# Service
desired_count = 1

# Fargate Spot (70% cheaper)
use_fargate_spot   = true
fargate_spot_weight = 100  # Use Spot for all tasks
fargate_spot_base   = 0    # No base tasks on regular Fargate

# IAM
execution_role_arn = "arn:aws:iam::123456789012:role/ecsTaskExecutionRole"
task_role_arn      = "arn:aws:iam::123456789012:role/batch-processor-role"

# No load balancer (background worker)
target_group_arn = ""


# Configuration 4: Scheduled Task (Cron Job)
# -------------------------------------------
# Cost: ~$0.05/run (runs once per day)

project_name = "myapp"
environment  = "prod"
service_name = "daily-backup"

container_image = "myapp/backup:latest"
container_port  = 0

# Resources
task_cpu    = "256"
task_memory = "512"

# Networking
subnet_ids         = ["subnet-private-1a"]
security_group_ids = ["sg-backup"]
assign_public_ip   = false

# Service (will be triggered by EventBridge, not running continuously)
create_service = false  # Don't create service, just task definition

# IAM
execution_role_arn = "arn:aws:iam::123456789012:role/ecsTaskExecutionRole"
task_role_arn      = "arn:aws:iam::123456789012:role/backup-task-role"

# Environment
environment_variables = {
  BACKUP_BUCKET = "s3://myapp-backups"
  RETENTION_DAYS = "30"
}

*/

# ----------------------------------------------------------------------------
# COST ESTIMATION GUIDE
# ----------------------------------------------------------------------------
/*

Fargate Pricing:
----------------

vCPU: $0.04048/hour
Memory: $0.004445/GB/hour

Examples (24/7 running):
------------------------

Tiny (0.25 vCPU, 512MB):
- vCPU: $0.04048 × 0.25 = $0.01012/hour
- Memory: $0.004445 × 0.5 = $0.002223/hour
- Total: ~$9/month

Small (0.5 vCPU, 1GB):
- Total: ~$18/month

Medium (1 vCPU, 2GB):
- Total: ~$35/month

Large (2 vCPU, 8GB):
- Total: ~$105/month

Fargate Spot (70% cheaper):
---------------------------
Small (0.5 vCPU, 1GB):
- Regular: ~$18/month
- Spot: ~$5/month
- Savings: $13/month (72%!)

When to use Spot:
✅ Development/testing
✅ Batch processing
✅ Non-critical workloads
✅ Fault-tolerant applications

When NOT to use Spot:
❌ Production APIs (interruptions = downtime)
❌ Real-time processing
❌ Stateful applications

Auto-Scaling Cost Example:
--------------------------
Service with auto-scaling (2-10 tasks):

Normal hours (2 tasks): $36/month
Peak hours (10 tasks): $180/hour × 4 hours/day × 30 days = $216/month

Average: ~$60-80/month (vs $360/month if always running 10 tasks)

*/
